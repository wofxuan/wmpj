IF OBJECT_ID('dbo.pbx_Base_UpdateK') IS NOT NULL 
    DROP PROCEDURE dbo.pbx_Base_UpdateK
go

--  ********************************************************************************************                                                                               
--  ||   过程名称：pbx_Base_UpdateE                                                 
--  ||   过程功能：修改基本信息--职员                                           
--  ********************************************************************************************
CREATE PROCEDURE pbx_Base_UpdateK
    (
      @TypeId VARCHAR(50) ,
      @Parid VARCHAR(50) ,
      @FullName VARCHAR(66) ,
      @UserCode VARCHAR(50) ,
      @Namepy VARCHAR(60) ,
      @Comment VARCHAR(250) ,
      --上面是基本信息必须的参数 ,
      @Name VARCHAR(66) ,--简称
      @Address VARCHAR(256) ,--地址
      @Person VARCHAR(100) ,--负责人
      @Tel VARCHAR(50) ,--负责人电话
      @IsStop INT ,
      --下面面是基本信息必须的参数
      @ErrorValue VARCHAR(500) OUTPUT  
    )
AS 
    DECLARE @OldCostMode INT
    DECLARE @OldProperty INT
    DECLARE @lSonNum INT
    DECLARE @OldIsSerial INT    
    DECLARE @dbname VARCHAR(30)
    DECLARE @checkValue INT
    DECLARE @UpdateTag INT --基本信息更新标识
    SET nocount ON
	
    SELECT  @dbname = 'tbx_Base_Ktype'

    IF EXISTS ( SELECT  [Kusercode]
                FROM    tbx_Base_Ktype
                WHERE   KtypeId <> '00000'
                        AND [KtypeId] <> @typeid
                        AND [Kusercode] = @usercode
                        AND [deleted] <> 1 ) 
        BEGIN
            SET @ErrorValue = '该记录的编号或全名与其它记录相同,不能更新！'
            GOTO ErrorGeneral
        END


	--如果叶子已经过帐，则不能修改成本算法
	--如果已经过帐，则不能修改成本算法
    --由非加权平均法改为加权平均法，则合并批次
	--由加权平均法改非为加权平均法，则判断是否有负库存

    SET @UpdateTag = 0
    --基本信息更新标识  
    --EXEC dbo.P_hh_XW_BaseUpdateTag @BaseType = @dbname, @UpdateTag = @UpdateTag OUTPUT
      
    UPDATE  dbo.tbx_Base_Ktype
    SET     [Parid] = @Parid, [KUsercode] = @UserCode, [KFullname] = @FullName, [KComment] = @Comment, 
			[Name] = @Name, [Address] = @Address, [Person] = @Person, [Tel] = @Tel, 
			[IsStop] = @IsStop, [Updatetag] = @UpdateTag
    WHERE   KTypeId = @typeId
      
    IF @@ROWCOUNT = 0 
        BEGIN
            SET @errorValue = '更新记录操作失败，请稍后重试！'
            GOTO ErrorGeneral
        END
        
    GOTO success    

    Success:		 --成功完成函数
    RETURN 0
    
    ErrorGeneral:    --检查数据是错误，不需要回滚
    RETURN -1   
    
    ErrorRollback:   --数据操作是错误，需要回滚
    --ROLLBACK TRAN insertproc 
    RETURN -2 
go
